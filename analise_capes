"""
================================================================================
AN√ÅLISE COMPLETA - CAT√ÅLOGO DE TESES CAPES SOBRE INTELIG√äNCIA ARTIFICIAL
================================================================================

VERS√ÉO 4.11 - T√çTULOS CONCISOS (REMO√á√ÉO DE INFO DIN√ÇMICA)

- T√≠tulos dos gr√°ficos (1, 2, 3, 4, 5, 6, 8, 9) simplificados para um formato conciso e est√°tico.
- Gr√°fico 4 (Institui√ß√µes): Gradiente AZUL (Blues_r).
- Gr√°fico 3 (√Åreas): Gradiente Roxo (Purples_r).
- Gr√°fico 2 (N√≠vel): Azul e Laranja.
- Mantidos os Tons Intermedi√°rios no restante do script.

INSTRU√á√ïES DE USO:
1. Coloque os arquivos de dados na mesma pasta
2. Execute: python analise_capes_ia_final.py
3. Os gr√°ficos ser√£o salvos na pasta 'graficos/' e exibidos na tela.

REQUISITOS:
pip install pandas numpy matplotlib seaborn openpyxl

================================================================================
"""

# =============================================================================
# IMPORTA√á√ïES
# =============================================================================
import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
import seaborn as sns
import os
import warnings
from collections import Counter
from matplotlib import cm # Importa√ß√£o necess√°ria para gradiente

warnings.filterwarnings('ignore')

# =============================================================================
# CONFIGURA√á√ïES DE VISUALIZA√á√ÉO
# =============================================================================
plt.style.use('default')
sns.set_style("whitegrid")

# Configura√ß√µes gerais
plt.rcParams['figure.figsize'] = (14, 8)
plt.rcParams['figure.facecolor'] = 'white'
plt.rcParams['axes.facecolor'] = 'white'
plt.rcParams['savefig.facecolor'] = 'white'
plt.rcParams['savefig.edgecolor'] = 'none'
plt.rcParams['figure.dpi'] = 100
plt.rcParams['savefig.dpi'] = 300
plt.rcParams['font.size'] = 10
plt.rcParams['axes.titlesize'] = 13
plt.rcParams['axes.labelsize'] = 11
plt.rcParams['axes.titleweight'] = 'bold'

# Paleta de cores INTERMEDI√ÅRIAS (Tons mais saturados que pastel, mas suaves)
CORES_INTERMEDIARIAS = [
    '#E57373',  # 0: Muted Red (Vermelho) - Base para G9 e Linha Mediana
    '#FFB74D',  # 1: Muted Orange (Laranja) - Doutorado G2/G6 e G9
    '#81C784',  # 2: Muted Green (Verde) - G8 e G9
    '#64B5F6',  # 3: Muted Blue (Azul) - G1, G7, Mestrado G2/G6 e Base Gradiente G4
    '#BA68C8',  # 4: Muted Purple (Roxo) - Base para Gradiente G3
    '#FFF176',  # 5: Muted Yellow
    '#F06292',  # 6: Muted Pink
    '#4DB6AC',  # 7: Muted Teal
    '#A1887F',  # 8: Muted Brown
    '#90A4AE',  # 9: Muted Blue-Gray
    '#B0BEC5',  # 10: Light Muted Gray
    '#E0E0E0',  # 11: Very Light Gray
]

# Cores espec√≠ficas para N√≠vel, Evolu√ß√£o e Foco IA
COR_AZUL_PRINCIPAL = CORES_INTERMEDIARIAS[3]   # Muted Blue (Gr√°ficos 1, 7)
COR_MESTRADO = CORES_INTERMEDIARIAS[3]         # Muted Blue (Mestrado G2/G6) 
COR_DOUTORADO = CORES_INTERMEDIARIAS[1]        # Muted Orange (Doutorado G2/G6) 
COR_MEDIANA = CORES_INTERMEDIARIAS[0]          # Muted Red (Gr√°fico 7 - Linha Mediana)
COR_IA_CENTRAL = CORES_INTERMEDIARIAS[0]       # Muted Red (Gr√°fico 5)
COR_IA_RELACIONADA = CORES_INTERMEDIARIAS[1]   # Muted Orange (Gr√°fico 5)
COR_IA_OUTROS = CORES_INTERMEDIARIAS[3]        # Muted Blue (Gr√°fico 5)
CORES_TOP3 = [CORES_INTERMEDIARIAS[0], CORES_INTERMEDIARIAS[1], CORES_INTERMEDIARIAS[2]] # G-9 (Red, Orange, Green)

def gerar_paleta_expandida(n):
    """Gera uma paleta de cores intermedi√°rias harmoniosas para n itens (usado para mais de 12 itens)"""
    if n <= len(CORES_INTERMEDIARIAS):
        return CORES_INTERMEDIARIAS[:n]
    
    paleta = CORES_INTERMEDIARIAS.copy()
    cores_extras = sns.color_palette("tab10", n - len(paleta))
    
    def mute_color(rgb_tuple):
        r, g, b = [int(c * 255) for c in rgb_tuple]
        r_muted = (r + 224) // 2 
        g_muted = (g + 224) // 2
        b_muted = (b + 224) // 2
        return '#{:02x}{:02x}{:02x}'.format(r_muted, g_muted, b_muted)

    for cor in cores_extras:
        paleta.append(mute_color(cor))
    
    return paleta[:n]

# Paletas espec√≠ficas para gr√°ficos menores
PALETA_3_CORES = [CORES_INTERMEDIARIAS[0], CORES_INTERMEDIARIAS[2], CORES_INTERMEDIARIAS[3]]

print("="*80)
print("AN√ÅLISE DO CAT√ÅLOGO DE TESES CAPES - INTELIG√äNCIA ARTIFICIAL")
print("="*80)
print("\nVERS√ÉO 4.11 - T√çTULOS CONCISOS")
print("="*80)

# =============================================================================
# 1. CARREGAR DADOS
# =============================================================================
print("\n[1/10] Carregando dados...")

# Verificar qual arquivo est√° dispon√≠vel
arquivo_dados = None
arquivos_possiveis = [
    'catalogo_teses_analise.xlsx',
    'catalogo_teses_analise__2_.xlsx',
    'catalogo_teses_limpo__2_.csv',
    'catalogodeteses__4_.csv'
]

for arquivo in arquivos_possiveis:
    if os.path.exists(arquivo):
        arquivo_dados = arquivo
        break

if arquivo_dados is None:
    print("\n‚ùå ERRO: Nenhum arquivo de dados encontrado!")
    print("   Arquivos esperados:", arquivos_possiveis)
    exit()

# Carregar dados
if arquivo_dados.endswith('.xlsx'):
    df = pd.read_excel(arquivo_dados, sheet_name='Dados Completos')
else:
    df = pd.read_csv(arquivo_dados)

print(f"‚úì Arquivo carregado: {arquivo_dados}")

# Limpeza inicial
df = df[df['id'] != 'col-md-1'].copy()
df = df[df['titulo'].notna()].copy()
df = df[df['autor'].notna()].copy()

# Normaliza√ß√£o
df['area_normalizada'] = df['area'].str.upper().str.strip()
df['ano_defesa'] = pd.to_numeric(df['ano_defesa'], errors='coerce').astype('Int64')
df['decada'] = (df['ano_defesa'] // 10 * 10).astype('Int64')

print(f"‚úì {len(df)} publica√ß√µes carregadas")
print(f"‚úì Per√≠odo: {int(df['ano_defesa'].min())}-{int(df['ano_defesa'].max())}")

# =============================================================================
# 2. CLASSIFICA√á√ÉO POR FOCO EM IA
# =============================================================================
print("\n[2/10] Classificando por foco em IA...")

keywords_ia_forte = [
    'intelig√™ncia artificial', 'ia ', 'artificial intelligence',
    'machine learning', 'deep learning', 'redes neurais', 'neural networks',
    'aprendizado de m√°quina', 'algoritmo', 'chatbot', 'gpt', 'llm'
]

keywords_ia_relacionada = [
    'transhumanismo', 'rob√≥tica', 'automa√ß√£o', 'digitaliza√ß√£o',
    'tecnologia digital', 'computacional', 'dados', 'big data',
    'internet', 'online', 'virtual', 'cibern√©tico'
]

def classificar_foco_ia(titulo):
    """Classifica o foco do trabalho em rela√ß√£o √† IA"""
    if pd.isna(titulo):
        return 'Outros Temas'
    
    titulo_lower = titulo.lower()
    
    for keyword in keywords_ia_forte:
        if keyword in titulo_lower:
            return 'IA - Foco Central'
    
    for keyword in keywords_ia_relacionada:
        if keyword in titulo_lower:
            return 'IA - Foco Relacionado'
    
    return 'Outros Temas'

df['foco_ia'] = df['titulo'].apply(classificar_foco_ia)
foco_counts = df['foco_ia'].value_counts()

print("‚úì Classifica√ß√£o conclu√≠da:")
for foco, count in foco_counts.items():
    print(f"  - {foco}: {count} ({count/len(df)*100:.1f}%)")

# =============================================================================
# 3. AN√ÅLISE TEMPORAL
# =============================================================================
print("\n[3/10] Analisando tend√™ncias temporais...")

pub_por_ano = df.groupby('ano_defesa').size().reset_index(name='quantidade')
pub_por_ano['ano_defesa'] = pub_por_ano['ano_defesa'].astype(int)
pub_por_ano = pub_por_ano.sort_values('ano_defesa')

anos_recentes = pub_por_ano[pub_por_ano['ano_defesa'] >= 2020]['quantidade'].sum()
crescimento = ((pub_por_ano.iloc[-1]['quantidade'] - pub_por_ano.iloc[0]['quantidade']) / 
               pub_por_ano.iloc[0]['quantidade'] * 100)

print(f"‚úì Crescimento: {crescimento:.0f}% (2013‚Üí2023)")
print(f"‚úì √öltimos 3 anos: {anos_recentes} publica√ß√µes ({anos_recentes/len(df)*100:.1f}%)")

# =============================================================================
# 4. AN√ÅLISE POR N√çVEL
# =============================================================================
print("\n[4/10] Analisando n√≠vel acad√™mico...")

nivel_counts = df['nivel'].value_counts()
nivel_ano = df.groupby(['ano_defesa', 'nivel']).size().unstack(fill_value=0)

print(f"‚úì Mestrados: {nivel_counts.get('Mestrado', 0)} ({nivel_counts.get('Mestrado', 0)/len(df)*100:.1f}%)")
print(f"‚úì Doutorados: {nivel_counts.get('Doutorado', 0)} ({nivel_counts.get('Doutorado', 0)/len(df)*100:.1f}%)")

# =============================================================================
# 5. AN√ÅLISE DE √ÅREAS (TODAS)
# =============================================================================
print("\n[5/10] Analisando todas as √°reas tem√°ticas...")

area_counts = df['area_normalizada'].value_counts()
# ORDENA√á√ÉO DECRESCENTE
areas_freq_maior_1 = area_counts[area_counts > 1].sort_values(ascending=False) 
areas_freq_1 = area_counts[area_counts == 1]

print(f"‚úì Total de √°reas: {len(area_counts)}")
print(f"‚úì √Åreas com 2+ publica√ß√µes: {len(areas_freq_maior_1)}")
print(f"‚úì √Åreas com 1 publica√ß√£o: {len(areas_freq_1)}")
print(f"‚úì Top 3 √°reas:")
for i, (area, count) in enumerate(area_counts.head(3).items(), 1):
    print(f"  {i}. {area}: {count} ({count/len(df)*100:.1f}%)")

# =============================================================================
# 6. AN√ÅLISE DE INSTITUI√á√ïES (TODAS)
# =============================================================================
print("\n[6/10] Analisando todas as institui√ß√µes...")

inst_counts = df['instituicao'].value_counts()
# ORDENA√á√ÉO DECRESCENTE
inst_freq_maior_1 = inst_counts[inst_counts > 1].sort_values(ascending=False)
inst_freq_1 = inst_counts[inst_counts == 1]

print(f"‚úì Total de institui√ß√µes: {len(inst_counts)}")
print(f"‚úì Institui√ß√µes com 2+ publica√ß√µes: {len(inst_freq_maior_1)}")
print(f"‚úì Institui√ß√µes com 1 publica√ß√£o: {len(inst_freq_1)}")
print(f"‚úì Top 3 institui√ß√µes:")
for i, (inst, count) in enumerate(inst_counts.head(3).items(), 1):
    print(f"  {i}. {inst}: {count} ({count/len(df)*100:.1f}%)")

# =============================================================================
# 7. AN√ÅLISE DE CIDADES
# =============================================================================
print("\n[7/10] Analisando distribui√ß√£o por cidades...")

cidade_counts = df['cidade'].value_counts() # J√° √© em ordem decrescente
print("‚úì Top 5 cidades:")
for i, (cidade, count) in enumerate(cidade_counts.head(5).items(), 1):
    print(f"  {i}. {cidade}: {count} ({count/len(df)*100:.1f}%)")

# =============================================================================
# 8. AN√ÅLISE DE TERMOS FREQUENTES
# =============================================================================
print("\n[8/10] Extraindo termos mais frequentes...")

def extrair_termos(texto):
    """Extrai termos relevantes do texto"""
    if pd.isna(texto):
        return []
    
    palavras = texto.lower().split()
    stopwords = {'de', 'da', 'do', 'dos', 'das', 'e', 'o', 'a', 'os', 'as', 
                 'em', 'no', 'na', 'nos', 'nas', 'para', 'com', 'por', 'um', 'uma'}
    
    termos = [p for p in palavras if len(p) > 4 and p not in stopwords]
    return termos

todos_termos = []
for titulo in df['titulo'].dropna():
    todos_termos.extend(extrair_termos(titulo))

termo_freq = Counter(todos_termos)
top_termos = termo_freq.most_common(20)

print(f"‚úì Top 5 termos: {', '.join([t[0] for t in top_termos[:5]])}")

# =============================================================================
# 9. AN√ÅLISE DE P√ÅGINAS
# =============================================================================
print("\n[9/10] Analisando n√∫mero de p√°ginas...")

df['num_paginas'] = pd.to_numeric(df['num_paginas'], errors='coerce')
paginas_stats = df['num_paginas'].describe()

print(f"‚úì M√©dia: {paginas_stats['mean']:.0f} p√°ginas")
print(f"‚úì Mediana: {paginas_stats['50%']:.0f} p√°ginas")

# =============================================================================
# 10. CRIAR PASTA PARA GR√ÅFICOS
# =============================================================================
print("\n[10/10] Preparando gera√ß√£o de gr√°ficos...")

if not os.path.exists('graficos'):
    os.makedirs('graficos')
    print("‚úì Pasta 'graficos/' criada")

# =============================================================================
# 11. GERAR GR√ÅFICOS
# =============================================================================
print("\n" + "="*80)
print("GERANDO GR√ÅFICOS COM CORES INTERMEDI√ÅRIAS E GRADIENTES")
print("="*80)

# GR√ÅFICO 1: Evolu√ß√£o Temporal (AZUL INTERMEDI√ÅRIO)
print("\nüìä Gr√°fico 1/9: Evolu√ß√£o Temporal das Publica√ß√µes")
fig, ax = plt.subplots(figsize=(12, 7), facecolor='white')
ax.plot(pub_por_ano['ano_defesa'], pub_por_ano['quantidade'], 
        marker='o', linewidth=3, markersize=10, 
        color=COR_AZUL_PRINCIPAL)
ax.fill_between(pub_por_ano['ano_defesa'], pub_por_ano['quantidade'], 
                alpha=0.4, color=COR_AZUL_PRINCIPAL) 

# T√≠tulo Simplificado
ax.set_title(f'Evolu√ß√£o temporal das publica√ß√µes (2013-2023)',
             fontweight='bold', fontsize=13, pad=20)
ax.set_xlabel('Ano de Defesa', fontsize=12)
ax.set_ylabel('Quantidade de Publica√ß√µes', fontsize=12)
ax.set_facecolor('white')
ax.grid(True, alpha=0.3, linestyle='--')

for i, row in pub_por_ano.iterrows():
    ax.text(row['ano_defesa'], row['quantidade'] + 0.5, str(int(row['quantidade'])),
            ha='center', va='bottom', fontweight='bold', fontsize=9)

plt.tight_layout()
plt.savefig('graficos/01_evolucao_temporal.png', dpi=300, bbox_inches='tight', facecolor='white')
plt.show()

# GR√ÅFICO 2: Distribui√ß√£o por N√≠vel (AZUL e LARANJA)
print("üìä Gr√°fico 2/9: Distribui√ß√£o por N√≠vel Acad√™mico - AZUL e LARANJA")
fig, ax = plt.subplots(figsize=(12, 7), facecolor='white')

nivel_counts_sorted = nivel_counts.sort_values(ascending=False)
colors = [COR_MESTRADO, COR_DOUTORADO] # Muted Blue e Muted Orange
bars = ax.bar(range(len(nivel_counts_sorted)), nivel_counts_sorted.values,
              color=colors[:len(nivel_counts_sorted)], edgecolor='black', linewidth=1.5)

ax.set_xticks(range(len(nivel_counts_sorted)))
ax.set_xticklabels(nivel_counts_sorted.index, fontsize=11)
# T√≠tulo Simplificado
ax.set_title(f'Distribui√ß√£o por n√≠vel acad√™mico',
             fontweight='bold', fontsize=13, pad=20)
ax.set_ylabel('Quantidade', fontsize=12)
ax.set_facecolor('white')
ax.grid(True, alpha=0.3, axis='y', linestyle='--')

for bar, v in zip(bars, nivel_counts_sorted.values):
    pct = (v/len(df))*100
    ax.text(bar.get_x() + bar.get_width()/2, v + 1, 
            f'{v}\n({pct:.1f}%)', ha='center', fontweight='bold', fontsize=10)

plt.tight_layout()
plt.savefig('graficos/02_nivel_academico.png', dpi=300, bbox_inches='tight', facecolor='white')
plt.show()

# GR√ÅFICO 3: TODAS AS √ÅREAS TEM√ÅTICAS (GRADIENTE ROXO/P√öRPURA)
print("üìä Gr√°fico 3/9: Todas as √Åreas Tem√°ticas (Frequ√™ncia > 1) - GRADIENTE ROXO")
fig, ax = plt.subplots(figsize=(14, max(10, len(areas_freq_maior_1) * 0.4)), facecolor='white')

areas_display = areas_freq_maior_1.copy()
N = len(areas_display)
# Colormap Purples_r (Roxo/P√∫rpura, Reverso para que o mais escuro fique no topo)
cmap = cm.get_cmap('Purples_r', N + 5)
cores = [cmap(i) for i in range(N)]

# Criar gr√°fico
bars = ax.barh(range(N), areas_display.values,
               color=cores, edgecolor='black', linewidth=1.2)

ax.set_yticks(range(N))
ax.set_yticklabels(areas_display.index, fontsize=9)
ax.invert_yaxis() 

# T√≠tulo Simplificado
ax.set_title(f'Distribui√ß√£o por √°reas tem√°ticas',
             fontweight='bold', fontsize=13, pad=20)
ax.set_xlabel('Quantidade de Publica√ß√µes', fontsize=11)
ax.set_facecolor('white')
ax.grid(True, alpha=0.3, axis='x', linestyle='--')

# Adicionar valores
for bar, v in zip(bars, areas_display.values):
    pct = (v/len(df))*100
    ax.text(v + 0.2, bar.get_y() + bar.get_height()/2,
            f'{int(v)} ({pct:.1f}%)', va='center', fontsize=8, fontweight='bold')

# Legenda para "Outras" no canto inferior
if len(areas_freq_1) > 0:
    areas_outras_lista = ', '.join(areas_freq_1.index[:10])
    if len(areas_freq_1) > 10:
        areas_outras_lista += f', ... (mais {len(areas_freq_1) - 10})'
    
    fig.text(0.12, 0.02, f'* √Åreas com 1 publica√ß√£o (total {len(areas_freq_1)}) incluem: {areas_outras_lista}',
             fontsize=8, style='italic', wrap=True,
             bbox=dict(boxstyle='round', facecolor=CORES_INTERMEDIARIAS[5], alpha=0.6)) 

plt.tight_layout()
plt.subplots_adjust(bottom=0.08)
plt.savefig('graficos/03_todas_areas.png', dpi=300, bbox_inches='tight', facecolor='white')
plt.show()

# GR√ÅFICO 4: TODAS AS INSTITUI√á√ïES (GRADIENTE AZUL)
print("üìä Gr√°fico 4/9: Todas as Institui√ß√µes (Frequ√™ncia > 1) - GRADIENTE AZUL")
fig, ax = plt.subplots(figsize=(14, max(10, len(inst_freq_maior_1) * 0.4)), facecolor='white')

inst_display = inst_freq_maior_1.copy()
N = len(inst_display)
# Colormap Blues_r
cmap = cm.get_cmap('Blues_r', N + 5)
cores_inst = [cmap(i) for i in range(N)]

# Criar gr√°fico
bars = ax.barh(range(N), inst_display.values,
               color=cores_inst, edgecolor='black', linewidth=1.2)

ax.set_yticks(range(N))
ax.set_yticklabels(inst_display.index, fontsize=9)
ax.invert_yaxis() 

# T√≠tulo Simplificado
ax.set_title(f'Distribui√ß√£o por institui√ß√µes',
             fontweight='bold', fontsize=13, pad=20)
ax.set_xlabel('Quantidade de Publica√ß√µes', fontsize=11)
ax.set_facecolor('white')
ax.grid(True, alpha=0.3, axis='x', linestyle='--')

# Adicionar valores
for bar, v in zip(bars, inst_display.values):
    pct = (v/len(df))*100
    ax.text(v + 0.15, bar.get_y() + bar.get_height()/2,
            f'{int(v)} ({pct:.1f}%)', va='center', fontsize=8, fontweight='bold')

# Legenda para "Outras" no canto inferior
if len(inst_freq_1) > 0:
    inst_outras_lista = ', '.join(inst_freq_1.index[:8])
    if len(inst_freq_1) > 8:
        inst_outras_lista += f', ... (mais {len(inst_freq_1) - 8})'
    
    fig.text(0.12, 0.02, f'* Institui√ß√µes com 1 publica√ß√£o (total {len(inst_freq_1)}) incluem: {inst_outras_lista}',
             fontsize=8, style='italic', wrap=True,
             bbox=dict(boxstyle='round', facecolor=CORES_INTERMEDIARIAS[5], alpha=0.6)) 

plt.tight_layout()
plt.subplots_adjust(bottom=0.08)
plt.savefig('graficos/04_todas_instituicoes.png', dpi=300, bbox_inches='tight', facecolor='white')
plt.show()

# GR√ÅFICO 5: Classifica√ß√£o por Foco em IA (CORES INTERMEDI√ÅRIAS)
print("üìä Gr√°fico 5/9: Classifica√ß√£o por Foco em IA")
fig, ax = plt.subplots(figsize=(12, 7), facecolor='white')

foco_order = ['IA - Foco Central', 'IA - Foco Relacionado', 'Outros Temas']
foco_counts_ordered = foco_counts.reindex(foco_order, fill_value=0)

colors_foco = [COR_IA_CENTRAL, COR_IA_RELACIONADA, COR_IA_OUTROS] # Cores Intermedi√°rias
bars = ax.bar(range(len(foco_counts_ordered)), foco_counts_ordered.values,
              color=colors_foco, edgecolor='black', linewidth=1.5)

ax.set_xticks(range(len(foco_counts_ordered)))
ax.set_xticklabels(foco_counts_ordered.index, fontsize=11, rotation=15, ha='right')
# T√≠tulo Simplificado
ax.set_title(f'Classifica√ß√£o por foco em Intelig√™ncia Artificial',
             fontweight='bold', fontsize=13, pad=20)
ax.set_ylabel('Quantidade', fontsize=12)
ax.set_facecolor('white')
ax.grid(True, alpha=0.3, axis='y', linestyle='--')

for bar, v in zip(bars, foco_counts_ordered.values):
    pct = (v/len(df))*100
    ax.text(bar.get_x() + bar.get_width()/2, v + 1,
            f'{v}\n({pct:.1f}%)', ha='center', fontweight='bold', fontsize=10)

plt.tight_layout()
plt.savefig('graficos/05_foco_ia.png', dpi=300, bbox_inches='tight', facecolor='white')
plt.show()

# GR√ÅFICO 6: Evolu√ß√£o por N√≠vel (AZUL e LARANJA)
print("üìä Gr√°fico 6/9: Evolu√ß√£o Temporal por N√≠vel")
fig, ax = plt.subplots(figsize=(12, 7), facecolor='white')

colors_nivel = [COR_MESTRADO, COR_DOUTORADO] # Muted Blue e Muted Orange
for i, nivel in enumerate(['Mestrado', 'Doutorado']):
    if nivel in nivel_ano.columns:
        ax.plot(nivel_ano.index, nivel_ano[nivel], marker='o',
                label=nivel, linewidth=3, color=colors_nivel[i], markersize=10)

# T√≠tulo Simplificado
ax.set_title(f'Evolu√ß√£o temporal por n√≠vel acad√™mico',
             fontweight='bold', fontsize=13, pad=20)
ax.set_xlabel('Ano', fontsize=12)
ax.set_ylabel('Publica√ß√µes', fontsize=12)
ax.legend(fontsize=11, loc='upper left')
ax.grid(True, alpha=0.3, linestyle='--')
ax.set_facecolor('white')

plt.tight_layout()
plt.savefig('graficos/06_evolucao_nivel.png', dpi=300, bbox_inches='tight', facecolor='white')
plt.show()

# GR√ÅFICO 7: Distribui√ß√£o de P√°ginas (AZUL e VERMELHO INTERMEDI√ÅRIO)
print("üìä Gr√°fico 7/9: Distribui√ß√£o do N√∫mero de P√°ginas")
fig, ax = plt.subplots(figsize=(12, 7), facecolor='white')

paginas_limpo = df['num_paginas'].dropna()
ax.hist(paginas_limpo, bins=25, color=COR_AZUL_PRINCIPAL, # Azul Intermedi√°rio
        edgecolor='black', alpha=0.8, linewidth=1.5)

n_com_paginas = len(paginas_limpo)
media = paginas_limpo.mean()
mediana = paginas_limpo.median()

# T√≠tulo Simplificado
ax.set_title(f'Distribui√ß√£o do N√∫mero de P√°ginas',
             fontweight='bold', fontsize=13, pad=20)
ax.set_xlabel('N√∫mero de P√°ginas', fontsize=12)
ax.set_ylabel('Frequ√™ncia', fontsize=12)
ax.axvline(mediana, color=COR_MEDIANA, linestyle='--', # Vermelho Intermedi√°rio
           linewidth=3, label=f'Mediana: {mediana:.0f} p√°ginas')
ax.legend(fontsize=11, loc='upper right')
ax.set_facecolor('white')
ax.grid(True, alpha=0.3, axis='y', linestyle='--')

plt.tight_layout()
plt.savefig('graficos/07_distribuicao_paginas.png', dpi=300, bbox_inches='tight', facecolor='white')
plt.show()

# GR√ÅFICO 8: Top 10 Cidades (GRADIENTE VERDE)
print("üìä Gr√°fico 8/9: Top 10 Cidades com Mais Publica√ß√µes - COR: GRADIENTE VERDE")
fig, ax = plt.subplots(figsize=(12, 7), facecolor='white')

top10_cidades = cidade_counts.head(10)
N = len(top10_cidades)
# Colormap Greens_r
cmap = cm.get_cmap('Greens_r', N + 5)
cores_cidades = [cmap(i) for i in range(N)]

bars = ax.barh(range(N), top10_cidades.values,
               color=cores_cidades, 
               edgecolor='black', linewidth=1.5)

ax.set_yticks(range(N))
ax.set_yticklabels(top10_cidades.index, fontsize=10)
ax.invert_yaxis() # Garante que o maior fique no topo

# T√≠tulo Simplificado
ax.set_title(f'Top 10 Cidades com Mais Publica√ß√µes',
             fontweight='bold', fontsize=13, pad=20)
ax.set_xlabel('Quantidade de Publica√ß√µes', fontsize=11)
ax.set_facecolor('white')
ax.grid(True, alpha=0.3, axis='x', linestyle='--')

for bar, v in zip(bars, top10_cidades.values):
    pct = (v/len(df))*100
    ax.text(v + 0.2, bar.get_y() + bar.get_height()/2,
            f'{int(v)} ({pct:.1f}%)', va='center', fontsize=9, fontweight='bold')

plt.tight_layout()
plt.savefig('graficos/08_top10_cidades.png', dpi=300, bbox_inches='tight', facecolor='white')
plt.show()

# GR√ÅFICO 9: Evolu√ß√£o das Top 3 √Åreas (VERMELHO, LARANJA, VERDE INTERMEDI√ÅRIO)
print("üìä Gr√°fico 9/9: Evolu√ß√£o temporal - Top 3 √°reas")
fig, ax = plt.subplots(figsize=(12, 7), facecolor='white')

top3_areas = area_counts.head(3).index
colors_top3 = CORES_TOP3 # Cores Intermedi√°rias
for i, area in enumerate(top3_areas):
    evolucao = df[df['area_normalizada'] == area].groupby('ano_defesa').size()
    ax.plot(evolucao.index, evolucao.values, marker='o', label=area,
            linewidth=3, color=colors_top3[i], markersize=10)

# T√≠tulo Simplificado
ax.set_title(f'Evolu√ß√£o Temporal - Top 3 √Åreas tem√°ticas',
             fontweight='bold', fontsize=13, pad=20)
ax.set_xlabel('Ano', fontsize=12)
ax.set_ylabel('Publica√ß√µes', fontsize=12)
ax.legend(fontsize=11, loc='upper left')
ax.grid(True, alpha=0.3, linestyle='--')
ax.set_facecolor('white')

plt.tight_layout()
plt.savefig('graficos/09_evolucao_top3_areas.png', dpi=300, bbox_inches='tight', facecolor='white')
plt.show()

print("\n‚úÖ Todos os 9 gr√°ficos foram salvos na pasta 'graficos/'")

# =============================================================================
# 12. EXPORTAR RESULTADOS
# =============================================================================
print("\n" + "="*80)
print("Exportando resultados detalhados...")
print("="*80)

output_excel = 'resultados_detalhados_teses_ia.xlsx'

with pd.ExcelWriter(output_excel, engine='openpyxl') as writer:
    # Resumo Geral
    resumo = pd.DataFrame({
        'M√©trica': [
            'Total de Publica√ß√µes',
            'Per√≠odo Analisado',
            'Mestrados',
            'Doutorados',
            'IA - Foco Central',
            'IA - Foco Relacionado',
            'Outros Temas',
            'N√∫mero de √Åreas',
            '√Åreas com 2+ publica√ß√µes',
            '√Åreas com 1 publica√ß√£o',
            'N√∫mero de Institui√ß√µes',
            'Institui√ß√µes com 2+ publica√ß√µes',
            'Institui√ß√µes com 1 publica√ß√£o',
            'Crescimento (%)',
            'Concentra√ß√£o √öltimos 3 anos (%)'
        ],
        'Valor': [
            len(df),
            f"{int(df['ano_defesa'].min())} - {int(df['ano_defesa'].max())}",
            nivel_counts.get('Mestrado', 0),
            nivel_counts.get('Doutorado', 0),
            foco_counts.get('IA - Foco Central', 0),
            foco_counts.get('IA - Foco Relacionado', 0),
            foco_counts.get('Outros Temas', 0),
            len(area_counts),
            len(areas_freq_maior_1),
            len(areas_freq_1),
            len(inst_counts),
            len(inst_freq_maior_1),
            len(inst_freq_1),
            f"{crescimento:.0f}%",
            f"{anos_recentes/len(df)*100:.1f}%"
        ]
    })
    resumo.to_excel(writer, sheet_name='Resumo Geral', index=False)
    
    # Outras planilhas
    pub_por_ano.to_excel(writer, sheet_name='Publica√ß√µes por Ano', index=False)
    area_counts.to_frame('Quantidade').to_excel(writer, sheet_name='Todas as √Åreas')
    inst_counts.to_frame('Quantidade').to_excel(writer, sheet_name='Todas as Institui√ß√µes')
    foco_counts.to_frame('Quantidade').to_excel(writer, sheet_name='Foco em IA')
    
    # √Åreas com frequ√™ncia 1
    if len(areas_freq_1) > 0:
        areas_freq_1.to_frame('Quantidade').to_excel(writer, sheet_name='√Åreas com 1 pub')
    
    # Institui√ß√µes com frequ√™ncia 1
    if len(inst_freq_1) > 0:
        inst_freq_1.to_frame('Quantidade').to_excel(writer, sheet_name='Institui√ß√µes com 1 pub')
    
    termos_df = pd.DataFrame(top_termos, columns=['Termo', 'Frequ√™ncia'])
    termos_df.to_excel(writer, sheet_name='Top Termos', index=False)
    
    df.to_excel(writer, sheet_name='Dataset Completo', index=False)

print(f"‚úì Resultados salvos: {output_excel}")

# =============================================================================
# 13. RELAT√ìRIO FINAL
# =============================================================================
print("\n" + "="*80)
print("RELAT√ìRIO FINAL - INSIGHTS PRINCIPAIS")
print("="*80)

print(f"""
üìä RESUMO EXECUTIVO:

1. VOLUME E CRESCIMENTO:
   ‚Ä¢ Total de {len(df)} teses/disserta√ß√µes analisadas
   ‚Ä¢ Per√≠odo: {int(df['ano_defesa'].min())} a {int(df['ano_defesa'].max())}
   ‚Ä¢ Mestrados: {nivel_counts.get('Mestrado', 0)} ({nivel_counts.get('Mestrado', 0)/len(df)*100:.1f}%)
   ‚Ä¢ Doutorados: {nivel_counts.get('Doutorado', 0)} ({nivel_counts.get('Doutorado', 0)/len(df)*100:.1f}%)

2. FOCO EM INTELIG√äNCIA ARTIFICIAL:
   ‚Ä¢ IA como foco central: {foco_counts.get('IA - Foco Central', 0)} ({foco_counts.get('IA - Foco Central', 0)/len(df)*100:.1f}%)
   ‚Ä¢ IA como tema relacionado: {foco_counts.get('IA - Foco Relacionado', 0)} ({foco_counts.get('IA - Foco Relacionado', 0)/len(df)*100:.1f}%)

3. PRINCIPAIS √ÅREAS:
   ‚Ä¢ Top 3 √°reas:
     1. {area_counts.index[0]}
     2. {area_counts.index[1]}
     3. {area_counts.index[2]}

4. PRINCIPAIS INSTITUI√á√ïES:
   ‚Ä¢ Top 3 institui√ß√µes:
     1. {inst_counts.index[0]}
     2. {inst_counts.index[1]}
     3. {inst_counts.index[2]}
""")

print("="*80)
print("‚úÖ AN√ÅLISE CONCLU√çDA COM SUCESSO!")
print("="*80)
print(f"\nArquivos gerados:")
print(f"  ‚Ä¢ 9 gr√°ficos na pasta 'graficos/' com T√çTULOS CONCISOS")
print(f"  ‚Ä¢ {output_excel}")
print(f"\nüí° DESTAQUE: T√≠tulos dos gr√°ficos est√£o simplificados e concisos.")
print("\n" + "="*80)
